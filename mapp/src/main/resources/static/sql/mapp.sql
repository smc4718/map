-- 시퀀스 삭제
DROP SEQUENCE USER_SEQ;
DROP SEQUENCE NOTICE_SEQ;
DROP SEQUENCE NOTICE_IMAGE_SEQ;

-- 시퀀스 생성
CREATE SEQUENCE USER_SEQ NOCACHE;
CREATE SEQUENCE NOTICE_SEQ NOCACHE;
CREATE SEQUENCE NOTICE_IMAGE_SEQ NOCACHE;

-- 테이블 삭제
DROP TABLE NOTICE_IMAGE_T;
DROP TABLE NOTICE_T;
DROP TABLE USER_T;

-- 회원 테이블
CREATE TABLE USER_T (
	USER_NO	        NUMBER	            NOT NULL,
    ID              VARCHAR2(20 BYTE)	NOT NULL UNIQUE,
	PW	            VARCHAR2(64 BYTE)	NOT NULL,
	NAME	        VARCHAR2(50 BYTE),
	GENDER	        VARCHAR2(2 BYTE),
    EMAIL           VARCHAR2(50 BYTE),
	HP	            VARCHAR2(20 BYTE),
    REFERRAL_CODE   VARCHAR2(20)                 UNIQUE,
    ROLE            VARCHAR2(20),
	JOINED_AT	    DATE
);

-- 공지
CREATE TABLE NOTICE_T (
	NOTICE_NO	NUMBER	            NOT NULL,
    USER_NO	    NUMBER	            NOT NULL,
	TITLE	    VARCHAR2(500 BYTE)	NOT NULL,
	CONTENTS	CLOB,
	HIT	        NUMBER              DEFAULT 0,
	CREATED_AT	VARCHAR2(30 BYTE)
);

-- 공지 이미지
CREATE TABLE NOTICE_IMAGE_T (
	NOTICE_NO	        NUMBER	            NOT NULL,
	IMAGE_PATH	        VARCHAR2(100 BYTE),
	FILESYSTEM_NAME 	VARCHAR2(100 BYTE)
);

-- PK
ALTER TABLE USER_T ADD CONSTRAINT PK_USER_T PRIMARY KEY (USER_NO);

ALTER TABLE NOTICE_T ADD CONSTRAINT PK_NOTICE_T PRIMARY KEY (NOTICE_NO);

-- FK

ALTER TABLE NOTICE_IMAGE_T ADD CONSTRAINT FK_NOTICE_T_TO_NOTICE_IMAGE_T_1 FOREIGN KEY (NOTICE_NO) 
REFERENCES NOTICE_T (NOTICE_NO) ON DELETE CASCADE;

ALTER TABLE NOTICE_T ADD CONSTRAINT FK_USER_T_TO_NOTICE_T_1 FOREIGN KEY (USER_NO) 
REFERENCES USER_T (USER_NO) ON DELETE CASCADE;

-- 직원
INSERT INTO USER_T VALUES(1, 'a', STANDARD_HASH('1', 'SHA256'), 'MAPP마스터', 'M', 'mapp@naver.com', '01011112222', 'ABCDEFGH', 'ADMIN', TO_DATE('250207', 'YYMMDD'));
INSERT INTO USER_T VALUES(2, 'b', STANDARD_HASH('2', 'SHA256'), 'A회원', 'F', 'member@naver.com', '01022223333', 'IJKLMNOP', 'USER', TO_DATE('250309', 'YYMMDD'));


-- USER_T가 존재할 경우, 최대값 + 1 을 기준으로 시퀀스를 재생성 (DB를 자주 초기화하며 확인해서, USER_NO 중복값 에러 생기지 않게 넣어둠)
DECLARE
    v_max NUMBER;
BEGIN
    SELECT NVL(MAX(USER_NO), 0) + 1 INTO v_max FROM USER_T;
    
    EXECUTE IMMEDIATE 'DROP SEQUENCE USER_SEQ';
    EXECUTE IMMEDIATE 'CREATE SEQUENCE USER_SEQ START WITH ' || v_max || ' NOCACHE';
END;

COMMIT;