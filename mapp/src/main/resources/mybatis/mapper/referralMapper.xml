<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.pyj.mapp.dao.ReferralMapper">

    <resultMap id="UserMap" type="UserDto">
        <id     column="USER_NO"        property="userNo" />
        <result column="ID"             property="id" />
        <result column="PW"             property="pw" />
        <result column="NAME"           property="name" />
        <result column="GENDER"         property="gender" />
        <result column="EMAIL"          property="email" />
        <result column="HP"             property="hp" />
        <result column="REFERRAL_CODE"  property="referralCode" />
        <result column="JOINED_AT"      property="joinedAt" />
    </resultMap>

    <!-- 추천 관계 입력 -->
    <insert id="insertReferral" parameterType="map">
        INSERT INTO REFERRAL_T (
        REFERRAL_NO
        , REFERRER_NO
        , REFERRED_NO
        , CREATED_AT
        ) VALUES (
        REFERRAL_SEQ.NEXTVAL
        , #{referrerNo}
        , #{referredNo}
        , SYSDATE
        )
    </insert>

    <!-- 추천인 기준으로 추천받은 회원 목록 조회 -->
    <select id="getReferredUsersByReferrerNo" parameterType="int" resultMap="UserMap">
        SELECT U.USER_NO, U.ID, U.PW, U.NAME, U.GENDER, U.EMAIL, U.HP, U.REFERRAL_CODE, U.ROLE, U.JOINED_AT
          FROM REFERRAL_T R JOIN USER_T U
               ON R.REFERRED_NO = U.USER_NO
         WHERE R.REFERRER_NO = #{referrerNo}
         ORDER BY U.JOINED_AT
    </select>

    <!-- 추천받은 사람 기준으로 추천인 조회 -->
    <select id="selectByReferrer" parameterType="int" resultMap="UserMap">
        SELECT U.USER_NO, U.ID, U.PW, U.NAME, U.GENDER, U.EMAIL, U.HP, U.REFERRAL_CODE, U.ROLE, U.JOINED_AT
          FROM REFERRAL_T R JOIN USER_T U
               ON R.REFERRER_NO = U.USER_NO
         WHERE R.REFERRED_NO = #{referredNo}
    </select>

</mapper>